#!/bin/bash

# Branch to merge from defaults to "master"
if [ ! -z "$1" -a "$1" != " " ];
then
	OTHER_BRANCH="$1"
else
	OTHER_BRANCH="master"
fi

# Return the name of the current branch
CURRENT_BRANCH=`git rev-parse --abbrev-ref HEAD`;

# create a temp file for capturing command output
TEMPFILE="`mktemp -t gup.XXXXXX`"
trap '{ rm -f "$TEMPFILE"; }' EXIT

# stash any uncommitted changes
git stash | tee "$TEMPFILE"
[ "${PIPESTATUS[0]}" -eq 0 ] || exit 1

# take note if anything was stashed
HAVE_STASH=0
grep -q "No local changes" "$TEMPFILE" || HAVE_STASH=1

git checkout $OTHER_BRANCH &&
git pull &&
git checkout $CURRENT_BRANCH &&
git pull &&
git merge $OTHER_BRANCH;

# restore any stashed changes
if [ "$HAVE_STASH" -ne 0 ]
then
    git stash pop
fi

